<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>gp1 – ECLIPSE Presentations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.32">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-dark"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = true;
    const darkModeDefault = authorPrefersDark;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ECLIPSE Presentations</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cheat_sheet.html"> 
<span class="menu-text">Cheat Sheet</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-gaussian-processes-1" id="toc-introduction-to-gaussian-processes-1" class="nav-link active" data-scroll-target="#introduction-to-gaussian-processes-1">Introduction to Gaussian Processes 1</a></li>
  <li><a href="#introduction-to-gaussian-processes-2" id="toc-introduction-to-gaussian-processes-2" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-2">Introduction to Gaussian Processes 2</a></li>
  <li><a href="#introduction-to-gaussian-processes-3" id="toc-introduction-to-gaussian-processes-3" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-3">Introduction to Gaussian Processes 3</a></li>
  <li><a href="#introduction-to-gaussian-processes-3.5" id="toc-introduction-to-gaussian-processes-3.5" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-3.5">Introduction to Gaussian Processes 3.5</a></li>
  <li><a href="#introduction-to-gaussian-processes-4" id="toc-introduction-to-gaussian-processes-4" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-4">Introduction to Gaussian Processes 4</a></li>
  <li><a href="#introduction-to-gaussian-processes-5" id="toc-introduction-to-gaussian-processes-5" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-5">Introduction to Gaussian Processes 5</a></li>
  <li><a href="#introduction-to-gaussian-processes-6" id="toc-introduction-to-gaussian-processes-6" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-6">Introduction to Gaussian Processes 6</a></li>
  <li><a href="#introduction-to-gaussian-processes-7" id="toc-introduction-to-gaussian-processes-7" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-7">Introduction to Gaussian Processes 7</a></li>
  <li><a href="#introduction-to-gaussian-processes-8" id="toc-introduction-to-gaussian-processes-8" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-8">Introduction to Gaussian Processes 8</a></li>
  <li><a href="#introduction-to-gaussian-processes-9" id="toc-introduction-to-gaussian-processes-9" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-9">Introduction to Gaussian Processes 9</a></li>
  <li><a href="#introduction-to-gaussian-processes-10" id="toc-introduction-to-gaussian-processes-10" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-10">Introduction to Gaussian Processes 10</a></li>
  <li><a href="#introduction-to-gaussian-processes-11" id="toc-introduction-to-gaussian-processes-11" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-11">Introduction to Gaussian Processes 11</a></li>
  <li><a href="#introduction-to-gaussian-processes-12" id="toc-introduction-to-gaussian-processes-12" class="nav-link" data-scroll-target="#introduction-to-gaussian-processes-12">Introduction to Gaussian Processes 12</a></li>
  <li><a href="#interactive-visualization" id="toc-interactive-visualization" class="nav-link" data-scroll-target="#interactive-visualization">Interactive Visualization</a></li>
  <li><a href="#so-what-is-a-gp-really" id="toc-so-what-is-a-gp-really" class="nav-link" data-scroll-target="#so-what-is-a-gp-really">So what is a GP, really?</a></li>
  <li><a href="#a-simple-example" id="toc-a-simple-example" class="nav-link" data-scroll-target="#a-simple-example">A Simple Example</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="05_gp1.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>





<section id="introduction-to-gaussian-processes-1" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-1">Introduction to Gaussian Processes 1</h2>
<ul>
<li>Gaussian processes provide a mechanism for directly reasoning about the high-level properties of functions that could fit our data.</li>
</ul>
<p>. . .</p>
<ul>
<li>may have a sense of whether these functions are quickly varying, periodic, involve conditional independencies, or translation invariance.</li>
</ul>
<p>. . .</p>
<ul>
<li>Gaussian processes: easily incorporate these properties into our model, by directly specifying a Gaussian distribution over the function values that could fit our data.</li>
</ul>
</section>
<section id="introduction-to-gaussian-processes-2" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-2">Introduction to Gaussian Processes 2</h2>
<ul>
<li><p>Suppose we observe the following dataset, of regression targets (outputs), <span class="math inline">\(y\)</span>, indexed by inputs, <span class="math inline">\(x\)</span>. <img src="img/gp-observed-data.svg" class="img-fluid" style="width:40.0%" alt="Observed data."></p></li>
<li><p>example: targets could be changes in carbon dioxide concentrations, inputs could be the times at which these targets have been recorded</p></li>
</ul>
<p>. . .</p>
<ul>
<li>What are some features of the data? How quickly does it seem to varying? Do we have data points collected at regular intervals, or are there missing inputs? How would you imagine filling in the missing regions, or forecasting up until <span class="math inline">\(x=25\)</span>?</li>
</ul>
</section>
<section id="introduction-to-gaussian-processes-3" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-3">Introduction to Gaussian Processes 3</h2>
<ul>
<li>start by specifying a prior distribution over what types of functions we might believe to be reasonable.</li>
</ul>
<p>. . .</p>
<ul>
<li>show several sample functions from a Gaussian process. Does this prior look reasonable? we are not looking for functions that fit our dataset, but instead for specifying reasonable high-level properties of the solutions, such as how quickly they vary with inputs. Note that we will see code for reproducing all of the plots in this notebook, in the next notebooks on priors and inference.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/gp-sample-prior-functions.svg" class="img-fluid figure-img" style="width:30.0%"></p>
<figcaption>Sample prior functions that we may want to represent with our model.</figcaption>
</figure>
</div>
</section>
<section id="introduction-to-gaussian-processes-3.5" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-3.5">Introduction to Gaussian Processes 3.5</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/bayes_law.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Bayes theorem</figcaption>
</figure>
</div>
</section>
<section id="introduction-to-gaussian-processes-4" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-4">Introduction to Gaussian Processes 4</h2>
<p>Once we condition on data, we can use this prior to infer a posterior distribution over functions that could fit the data. Here we show sample posterior functions.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/gp-sample-posterior-functions.svg" class="img-fluid figure-img"></p>
<figcaption>Sample posterior functions, once we have observed the data.</figcaption>
</figure>
</div>
<p>. . .</p>
<ul>
<li>each of these functions are entirely consistent with our data, perfectly running through each observation.</li>
</ul>
<p>. . .</p>
<ul>
<li>In order to use these posterior samples to make predictions, we can average the values of every possible sample function from the posterior, to create the curve below, in thick blue.</li>
</ul>
<p>. . .</p>
<ul>
<li>Note that we do not actually have to take an infinite number of samples to compute this expectation; as we will see later, we can compute the expectation in closed form.</li>
</ul>
</section>
<section id="introduction-to-gaussian-processes-5" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-5">Introduction to Gaussian Processes 5</h2>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/gp-posterior-samples.svg" class="img-fluid figure-img" style="width:10in"></p>
<figcaption>Posterior samples, alongside posterior mean, which can be used for point predictions, in blue.</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<ul>
<li><p>may also want a representation of uncertainty, so we know how confident we should be in our predictions.</p></li>
<li><p>Intuitively: more variability in the sample posterior functions –&gt; more uncertainty</p></li>
<li><p><em>epistemic uncertainty</em>, which is the <em>reducible uncertainty</em> associated with lack of information.</p></li>
<li><p>acquire more data –&gt; this type of uncertainty disappears, as there will be increasingly fewer solutions consistent with what we observe.</p></li>
<li><p>Like with the posterior mean, we can compute the posterior variance (the variability of these functions in the posterior) in closed form.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="introduction-to-gaussian-processes-6" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-6">Introduction to Gaussian Processes 6</h2>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/gp-posterior-samples-95.svg" class="img-fluid figure-img" style="width:10in"></p>
<figcaption>Posterior samples, including 95% credible set.</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<ul>
<li>shade: two times the posterior standard deviation on either side of the mean, creating a <em>credible interval</em> that has a 95% probability of containing the true value of the function for any input <span class="math inline">\(x\)</span>.</li>
<li>plot looks somewhat cleaner if we remove the posterior samples, simply visualizing the data, posterior mean, and 95% credible set.</li>
<li>Notice how the uncertainty grows away from the data, a property of epistemic uncertainty.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="introduction-to-gaussian-processes-7" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-7">Introduction to Gaussian Processes 7</h2>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/gp-point-predictions.svg" class="img-fluid figure-img" style="width:10in"></p>
<figcaption>Point predictions, and credible set.</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<ul>
<li><p>properties of the Gaussian process that we used to fit the data are strongly controlled by what’s called a <em>covariance function</em>, also known as a <em>kernel</em>.</p></li>
<li><p>covariance function we used is called the <em>RBF (Radial Basis Function) kernel</em>, which has the form <span class="math display">\[ k_{\text{RBF}}(x,x') = \mathrm{Cov}(f(x),f(x')) = a^2 \exp\left(-\frac{1}{2\ell^2}\|x-x'\|^2\right) \]</span></p></li>
<li><p>The <em>hyperparameters</em> of this kernel are interpretable. The <em>amplitude</em> parameter <span class="math inline">\(a\)</span> controls the vertical scale over which the function is varying, and the <em>length-scale</em> parameter <span class="math inline">\(\ell\)</span> controls the rate of variation (the wiggliness) of the function.</p></li>
<li><p>Larger <span class="math inline">\(a\)</span> means larger function values, and larger <span class="math inline">\(\ell\)</span> means more slowly varying functions. Let’s see what happens to our sample prior and posterior functions as we vary <span class="math inline">\(a\)</span> and <span class="math inline">\(\ell\)</span>.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="introduction-to-gaussian-processes-8" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-8">Introduction to Gaussian Processes 8</h2>
<p><span class="math display">\[ k_{\text{RBF}}(x,x') = \mathrm{Cov}(f(x),f(x')) = a^2 \exp\left(-\frac{1}{2\ell^2}\|x-x'\|^2\right) \]</span></p>
<ul>
<li><p>The <em>length-scale</em> has a particularly pronounced effect on the predictions and uncertainty of a GP. At <span class="math inline">\(\|x-x'\| = \ell\)</span> , the covariance between a pair of function values is <span class="math inline">\(a^2\exp(-0.5)\)</span>.</p></li>
<li><p>At larger distances than <span class="math inline">\(\ell\)</span> , the values of the function values becomes nearly uncorrelated. This means that if we want to make a prediction at a point <span class="math inline">\(x_*\)</span>, then function values with inputs <span class="math inline">\(x\)</span> such that <span class="math inline">\(\|x-x'\|&gt;\ell\)</span> will not have a strong effect on our predictions.</p></li>
</ul>
</section>
<section id="introduction-to-gaussian-processes-9" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-9">Introduction to Gaussian Processes 9</h2>
<ul>
<li>how changing the lengthscale affects sample prior and posterior functions, and credible sets. The above fits use a length-scale of <span class="math inline">\(2\)</span>. Let’s now consider <span class="math inline">\(\ell = 0.1, 0.5, 2, 5, 10\)</span> .</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="img/gp-priorpoint1.svg" class="img-fluid" style="width:45.0%" alt="priorpoint1"> <img src="img/gp-postpoint1.svg" class="img-fluid" style="width:45.0%" alt="postpoint1"> <img src="img/gp-priorpoint5.svg" class="img-fluid" style="width:45.0%" alt="priorpoint5"> <img src="img/gp-postpoint5.svg" class="img-fluid" style="width:45.0%" alt="postpoint5"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<ul>
<li>A length-scale of <span class="math inline">\(0.1\)</span> is very small relative to the range of the input domain we are considering, <span class="math inline">\(25\)</span>. For example, the values of the function at <span class="math inline">\(x=5\)</span> and <span class="math inline">\(x=10\)</span> will have essentially no correlation at such a length-scale.</li>
<li>On the other hand, for a length-scale of <span class="math inline">\(10\)</span>, the function values at these inputs will be highly correlated.</li>
<li>Note that the vertical scale changes in the following figures.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="introduction-to-gaussian-processes-10" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-10">Introduction to Gaussian Processes 10</h2>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="img/gp-prior2.svg" class="img-fluid" style="width:40.0%" alt="prior2"> <img src="img/gp-post2.svg" class="img-fluid" style="width:40.0%" alt="post2"> <img src="img/gp-prior5.svg" class="img-fluid" style="width:40.0%" alt="prior5"> <img src="img/gp-post5.svg" class="img-fluid" style="width:40.0%" alt="post5"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<ul>
<li>length-scale of <span class="math inline">\(0.1\)</span> is very small relative to the range of the input domain we are considering, <span class="math inline">\(25\)</span>.</li>
<li>For example, the values of the function at <span class="math inline">\(x=5\)</span> and <span class="math inline">\(x=10\)</span> will have essentially no correlation at such a length-scale.</li>
<li>On the other hand, for a length-scale of <span class="math inline">\(10\)</span>, the function values at these inputs will be highly correlated.</li>
<li>Note that the vertical scale changes in the following figures.</li>
</ul>
</div>
</div>
</div>
<ul>
<li>as the length-scale increases the ‘wiggliness’ of the functions decrease, and our uncertainty decreases.</li>
<li>If the length-scale is small, the uncertainty will quickly increase as we move away from the data, as the datapoints become less informative about the function values.</li>
</ul>
</section>
<section id="introduction-to-gaussian-processes-11" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-11">Introduction to Gaussian Processes 11</h2>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="img/gp-priorap1.svg" class="img-fluid" style="width:40.0%" alt="priorap1"> <img src="img/gp-postapoint1.svg" class="img-fluid" style="width:40.0%" alt="postapoint1"> <img src="img/gp-priora2.svg" class="img-fluid" style="width:40.0%" alt="priora2"> <img src="img/gp-posta2.svg" class="img-fluid" style="width:40.0%" alt="posta2"> <img src="img/gp-priora8.svg" class="img-fluid" style="width:40.0%" alt="priora8"> <img src="img/gp-posta8.svg" class="img-fluid" style="width:40.0%" alt="posta8"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<ul>
<li>now vary the amplitude parameter, holding the length-scale fixed at <span class="math inline">\(2\)</span>.</li>
<li>Note the vertical scale is held fixed for the prior samples, and varies for the posterior samples, so you can clearly see both the increasing scale of the function, and the fits to the data.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="introduction-to-gaussian-processes-12" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-gaussian-processes-12">Introduction to Gaussian Processes 12</h2>
<p><span class="math display">\[ k_{\text{RBF}}(x,x') = \mathrm{Cov}(f(x),f(x')) = a^2 \exp\left(-\frac{1}{2\ell^2}\|x-x'\|^2\right) \]</span></p>
<p>. . .</p>
<ul>
<li><p>amplitude parameter affects the scale of the function, but not the rate of variation. . . .</p></li>
<li><p>generalization performance of our procedure will depend on having reasonable values for these hyperparameters. . . .</p></li>
<li><p>Values of <span class="math inline">\(\ell=2\)</span> and <span class="math inline">\(a=1\)</span> appeared to provide reasonable fits, while some of the other values did not.</p></li>
</ul>
<p>. . .</p>
<ul>
<li>Fortunately, there is a robust and automatic way to specify these hyperparameters, using what is called the <em>marginal likelihood</em>, which we will return to in the notebook on inference.</li>
</ul>
</section>
<section id="interactive-visualization" class="level2">
<h2 class="anchored" data-anchor-id="interactive-visualization">Interactive Visualization</h2>
<iframe src="https://www.infinitecuriosity.org/vizgp/" style="width:100%; height:800px;" frameborder="0" scrolling="yes">
</iframe>
<script>
window.addEventListener('load', function() {
    var iframe = document.querySelector('iframe');
    var iframeDoc = iframe.contentWindow.document;
    
    // Hide everything except the body content
    var style = iframeDoc.createElement('style');
    style.textContent = `
        header, footer, nav, aside {
            display: none !important;
        }
        body {
            margin: 0;
            padding: 0;
        }
    `;
    iframeDoc.head.appendChild(style);
});
</script>
</section>
<section id="so-what-is-a-gp-really" class="level2">
<h2 class="anchored" data-anchor-id="so-what-is-a-gp-really">So what is a GP, really?</h2>
<ul>
<li>GP: any collection of function values <span class="math inline">\(f(x_1),\dots,f(x_n)\)</span>, indexed by any collection of inputs <span class="math inline">\(x_1,\dots,x_n\)</span> has a joint multivariate Gaussian distribution.</li>
</ul>
<p>. . .</p>
<ul>
<li><p>mean vector <span class="math inline">\(\boldsymbol{\mu}\)</span> of this distribution is given by a <em>mean function</em>, which is typically taken to be a constant or zero.</p></li>
<li><p>covariance matrix of this distribution is given by the <em>kernel</em> evaluated at all pairs of the inputs <span class="math inline">\(x\)</span>.</p></li>
</ul>
<p>. . .</p>
<ul>
<li><p><span class="math display">\[\begin{bmatrix}f(x) \\f(x_1) \\ \vdots \\ f(x_n) \end{bmatrix}\sim \mathcal{N}\left(\boldsymbol{\mu}, \begin{bmatrix}k(x,x) &amp; k(x, x_1) &amp; \dots &amp; k(x,x_n) \\ k(x_1,x) &amp; k(x_1,x_1) &amp; \dots &amp; k(x_1,x_n) \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ k(x_n,x) &amp; k(x_n,x_1) &amp; \dots &amp; k(x_n,x_n) \end{bmatrix}\right)\]</span></p></li>
<li><p>Equation <code>(1)</code> specifies a GP prior. We can compute the conditional distribution of <span class="math inline">\(f(x)\)</span> for any <span class="math inline">\(x\)</span> given <span class="math inline">\(f(x_1), \dots, f(x_n)\)</span>, the function values we have observed.</p></li>
</ul>
<p>. . .</p>
<ul>
<li>This conditional distribution is also Gaussian, with mean <span class="math inline">\(m\)</span> and variance <span class="math inline">\(s^2\)</span>:</li>
</ul>
<p><span class="math display">\[f(x) | f(x_1), \dots, f(x_n) \sim \mathcal{N}(m,s^2)\]</span></p>
<ul>
<li>where <span class="math inline">\(m\)</span> and <span class="math inline">\(s^2\)</span> are functions of <span class="math inline">\(x\)</span> and the observed function values.</li>
</ul>
<hr>
<ul>
<li>if we want to create an interval with a 95% probability that <span class="math inline">\(f(x)\)</span> is in the interval, we would use <span class="math inline">\(m \pm 2s\)</span>.</li>
</ul>
<p>. . .</p>
<ul>
<li>This is the essence of Gaussian process inference: we specify a prior over functions, and then we condition on observed function values to get a posterior over functions.</li>
</ul>
</section>
<section id="a-simple-example" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-example">A Simple Example</h2>
<ul>
<li>suppose we observe a single datapoint, <span class="math inline">\(f(x_1)\)</span>, and we want to determine the value of <span class="math inline">\(f(x)\)</span> at some <span class="math inline">\(x\)</span>.</li>
<li><span class="math inline">\(f(x)\)</span> described by Gaussian process –&gt; joint distribution over <span class="math inline">\((f(x), f(x_1))\)</span> is Gaussian:</li>
</ul>
<p><span class="math display">\[\begin{bmatrix}
f(x) \\
f(x_1)
\end{bmatrix} \sim \mathcal{N}\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix} k(x,x) &amp; k(x,x_1) \\ k(x_1,x) &amp; k(x_1,x_1) \end{bmatrix}\right)\]</span></p>
<ul>
<li>The covariance <span class="math inline">\(k(x,x_1)\)</span> tells us how correlated the function values will be — how strongly determined <span class="math inline">\(f(x)\)</span> is by <span class="math inline">\(f(x_1)\)</span>.</li>
</ul>
<p>. . .</p>
<ul>
<li>visualize the process of determining <span class="math inline">\(f(x)\)</span> from <span class="math inline">\(f(x_1)\)</span> both in the space of functions, and in the joint distribution over <span class="math inline">\(f(x_1), f(x)\)</span>.</li>
<li>initially consider an <span class="math inline">\(x\)</span> such that <span class="math inline">\(k(x,x_1) = 0.9\)</span>, and <span class="math inline">\(k(x,x)=1\)</span>, meaning that the value of <span class="math inline">\(f(x)\)</span> is moderately correlated with the value of <span class="math inline">\(f(x_1)\)</span>.</li>
</ul>
<p>. . .</p>
<ul>
<li><p>If we observe <span class="math inline">\(f(x_1) = 1.2\)</span>, then we can draw a horizontal line at <span class="math inline">\(1.2\)</span> on our plot of the density, and see that the value of <span class="math inline">\(f(x)\)</span> is likely to be around <span class="math inline">\(1.08\)</span>.</p></li>
<li><p>The orange point shows the observed point <span class="math inline">\(f(x_1)\)</span> in orange, and 1 standard deviation of the Gaussian process predictive distribution for <span class="math inline">\(f(x)\)</span> is shown in blue.</p></li>
</ul>
<hr>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://user-images.githubusercontent.com/6753639/206867364-b4707db5-0c2e-4ae4-a412-8292bca4d08d.svg" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>Contours of constant probability of a bivariate Gaussian density over <span class="math inline">\(f(x_1)\)</span> and <span class="math inline">\(f(x)\)</span> with <span class="math inline">\(k(x,x_1) = 0.9\)</span>.</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://user-images.githubusercontent.com/6753639/206867367-3815720c-93c8-4b4b-80e7-296db1d3553b.svg" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>Gaussian process predictive distribution in function space at <span class="math inline">\(f(x)\)</span>, with <span class="math inline">\(k(x,x_1) = 0.9\)</span>.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li><p>If we increase the correlation to <span class="math inline">\(k(x,x_1) = 0.95\)</span>, then the ellipses have narrowed further, and the value of <span class="math inline">\(f(x)\)</span> is more strongly determined by <span class="math inline">\(f(x_1)\)</span>.</p></li>
<li><p>Drawing a horizontal line at <span class="math inline">\(1.2\)</span>, we see the contours for <span class="math inline">\(f(x)\)</span> are more concentrated around <span class="math inline">\(1.14\)</span>.</p></li>
</ul>
<hr>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="https://user-images.githubusercontent.com/6753639/206867797-20e42783-31de-4c50-80e3-e9441ba6d0a9.svg" class="img-fluid" style="width:35.0%" alt="Contours of constant probability of a bivariate Gaussian density over f(x_1) and f(x) with k(x,x_1) = 0.95."> <img src="https://user-images.githubusercontent.com/6753639/206867800-d9fc7add-649d-492c-8048-cab07c8fb83e.svg" class="img-fluid" style="width:35.0%" alt="Gaussian process predictive distribution in function space at f(x), with k(x,x_1) = 0.95."></p>
</div>
</div>
</div>
<ul>
<li>This procedure can give us a posterior on <span class="math inline">\(f(x)\)</span> for any <span class="math inline">\(x\)</span>, for any number of points we have observed.</li>
</ul>
<p>. . .</p>
<ul>
<li>visualize the posterior for <span class="math inline">\(f(x)\)</span> at a particular <span class="math inline">\(x=x'\)</span> in function space.</li>
<li>exact distribution for <span class="math inline">\(f(x)\)</span> is given by the above equations. <span class="math inline">\(f(x)\)</span> is Gaussian distributed, with mean</li>
</ul>
<p><span class="math display">\[m = k(x,x_1) k(x_1,x_1)^{-1} f(x_1)\]</span></p>
<p>and variance</p>
<p><span class="math display">\[s^2 = k(x,x) - k(x,x_1) k(x_1,x_1)^{-1} k(x_1,x)\]</span></p>
<p>. . .</p>
<ul>
<li>easy to include observation noise. If we assume that the data are generated from a latent noise free function <span class="math inline">\(f(x)\)</span> plus iid Gaussian noise <span class="math inline">\(\epsilon(x) \sim \mathcal{N}(0,\sigma^2)\)</span>, then we can write</li>
</ul>
<p><span class="math display">\[y(x) = f(x) + \epsilon(x)\]</span></p>
<p>. . .</p>
<ul>
<li>The joint distribution over <span class="math inline">\(y(x_1)\)</span> and <span class="math inline">\(f(x)\)</span> is then</li>
</ul>
<p><span class="math display">\[\begin{bmatrix}
y(x_1) \\
f(x)
\end{bmatrix} \sim \mathcal{N}\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix} k(x_1,x_1) + \sigma^2 &amp; k(x_1,x) \\ k(x,x_1) &amp; k(x,x) \end{bmatrix}\right)\]</span></p>
<p>. . .</p>
<ul>
<li>The conditional distribution of <span class="math inline">\(f(x)\)</span> given <span class="math inline">\(y(x_1)\)</span> is then</li>
</ul>
<p><span class="math display">\[f(x) | y(x_1) \sim \mathcal{N}(m,s^2)\]</span></p>
<p>where</p>
<p><span class="math display">\[m = k(x,x_1) (k(x_1,x_1) + \sigma^2)^{-1} y(x_1)\]</span></p>
<p>and</p>
<p><span class="math display">\[s^2 = k(x,x) - k(x,x_1) (k(x_1,x_1) + \sigma^2)^{-1} k(x_1,x)\]</span></p>
<p>. . .</p>
<ul>
<li>This is the basic form of Gaussian process regression. We can extend this to multiple observations, and we can also learn the hyperparameters of the kernel from the data.</li>
</ul>
</section>
<section id="exercise" class="level2">
<h2 class="anchored" data-anchor-id="exercise">Exercise</h2>
<ul>
<li>Suppose we observe two points, <span class="math inline">\(y(x_1) = 1.2\)</span> and <span class="math inline">\(y(x_2) = 0.8\)</span>, with noise variance <span class="math inline">\(\sigma^2 = 0.1\)</span>.</li>
<li>Are we more or less certain about the value of <span class="math inline">\(f(x)\)</span>, than when we had only observed <span class="math inline">\(f(x_1)\)</span>? What is the mean and 95% credible set for our value of <span class="math inline">\(f(x)\)</span> now?</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>