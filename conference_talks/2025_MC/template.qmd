---
title: |
  STEM Ptychography: <br> Basics & Applications<br>in the Physical Sciences
bibliography: ref.bib
# csl: custom.csl
author:
  - name: Prof. Dr. Philipp Pelz
    affiliation: 
      - FAU Erlangen-Nürnberg
      - Institute of Micro- and Nanostructure Research
   
execute: 
  eval: true
  echo: true
format:
    revealjs: 
        # scroll-view:
        #     activate: true
        #     snap: mandatory
        #     layout: full
        width: 1920
        height: 1080
        menu:
            side: right
            width: wide
        template-partials:
            - title-slide.html
        css: custom.css
        theme: custom.scss
        slide-number: c/t    
        logo: "eclipse_logo_small.png" 
        highlight-style: a11y
        incremental: false 
        background-transition: fade
        footer: "©Philipp Pelz - FAU Erlangen-Nürnberg - MC 2025 - 4D STEM Concepts and applications in the physical and life sciences - STEM Ptychography"
 
---
  


## Outline

::: {.outline-container}

::: {.outline-box .fragment data-fragment-index="0"}
### 
![](./images/4DSTEM_render_0_1.jpg){width="100%"} 
:::

::: {.outline-box .fragment data-fragment-index="1"} 
### 
![](./extracted_media/02_ctf.png) 
:::

::: {.outline-box .fragment data-fragment-index="2"}  
### 
![](./extracted_media/03_iterative_methods.png) 
::: 
   
::: {.outline-box .fragment data-fragment-index="3"} 
### 
![](./extracted_media/04_outlook.png) 
:::

:::

<style>
/* Outline box title switching - slide specific */
.outline-box.fragment[data-fragment-index="0"]:not(.current-fragment) h3::before {
  content: ""; 
}

.outline-box.fragment[data-fragment-index="0"].current-fragment h3::before {
  content: "Basics, History & Early Demonstrations";
  transition: all 0.8s ease;
}

.outline-box.fragment[data-fragment-index="1"]:not(.current-fragment) h3::before {
  content: "";
}

.outline-box.fragment[data-fragment-index="1"].current-fragment h3::before {
  content: "Direct Methods & Contrast Transfer";
  transition: all 0.8s ease;
}

.outline-box.fragment[data-fragment-index="2"]:not(.current-fragment) h3::before {
  content: "";
}

.outline-box.fragment[data-fragment-index="2"].current-fragment h3::before {
  content: "Iterative Methods";
  transition: all 0.8s ease;
}

.outline-box.fragment[data-fragment-index="3"]:not(.current-fragment) h3::before {
  content: "";
}

.outline-box.fragment[data-fragment-index="3"].current-fragment h3::before {
  content: "Outlook: Fields, Disorder, Dynamics";
  transition: all 0.8s ease;
}
</style>
 
## Ptychography: The origins 

- The diffraction signal in STEM contains the phase information of the sample

$$
T(\vec{r}) = \exp^{i \sigma V(\vec{r})}
$$

- The phase shift $\sigma$ is related to the potential $V(\vec{r})$ of the sample


- Question: How can we measure the phase shifts of a sample in the STEM?



#### "In the case of inorganic crystals, and perhaps also in the case of radiation-sensitive organic crystals, these procedures could easily<br> develop into being competitors for the methods described in Sections 2.3-2.10 (CTEM, Zone plates)" [1]


::: {.aside}
[1] @Frank_2022 [2] @Hoppe_1983
:::
 
![](./images/walter_hoppe.jpeg){width="10%" style="position: absolute; top: 0px; right: 0px;"}
<span style="position: absolute; top: 220px; right: 0px; font-size: 0.8em;">Walter Hoppe [1]</span>

## Analytical Theory and Contrast Transfer

::: {.columns}
::: {.column width="55%"}

- The phase contrast transfer function (PCTF) describes how phase information is transferred in ptychography
- For weak phase objects, the PCTF can be written as:

$$
\text{PCTF}(\mathbf{Q}_p) = \frac{1}{2} \frac{\sum_{\mathbf{K}_f} |\Gamma_A(\mathbf{K}_f, \mathbf{Q}_p)|}{\sum_{\mathbf{K}_f} |A(\mathbf{K}_f)|}
$$

where:

- $\mathbf{Q}_p$ is the scanning spatial frequency 
- $\mathbf{K}_f$ are detector reciprocal space coordinates
- $\Gamma_A = A^*(\mathbf{K}_f)A(\mathbf{K}_f - \mathbf{Q}_p) - A(\mathbf{K}_f)A^*(\mathbf{K}_f + \mathbf{Q}_p)$ is the aperture transfer function
- $A$ is the aperture function



:::
::: {.column width="45%"}

- The PCTF shows how different spatial frequencies are transferred
- Optimal transfer occurs when PCTF = 1
- Transfer is reduced when direct beam and diffracted beam do not interfere constructively

:::
:::

::: {.callout-note}
The PCTF allows optimize defocus for best phase contrast for each sample
:::
## Analytical Theory and Contrast Transfer: Visual

<div class="iframe-container" style="height: 800px;">
<iframe
  id="marimo-frame"
  src="https://pelzlab.science/marimo/apps/ptychographic_ctf.html?mode=read&embed=true"
  frameBorder="0"  
  width="100%"
  height="800px"
  style="border: none; filter: invert(1) hue-rotate(180deg);"
></iframe></div>

::: {.callout-note} 

tune convergence angle and defocus to maximize phase contrast for your spatial frequencies of interest

::: 

## Direct Reconstruction Methods

::: {.columns}
::: {.column width="55%"}

- Direct reconstruction methods aim to solve the phase problem without iterative optimization
- The **Wigner Distribution Deconvolution (WDD)** method:
  - Deconvolves the measured intensity from probe effects 
  - Sensitive to noise and deconvolution hyperparameter
- The **Single-Side Band (SSB)** or **Weak Phase Object (WPO)** method:
  - deconvolution through multiplication in double Fourier space
  - SSB: fixed CTF independent on defocus
  - WPO: CTF dependent on defocus, high defocus beneficial
:::
::: {.column width="45%"}

- Advantages:
  - Fast reconstruction without iterations
  - No hyperparmaeters to tune (SSB & WPO)
  - Computationally efficient

- Limitations:
 
  - May have artifacts from approximations
  - Works best for weak phase objects

:::
:::

::: {.callout-note}
Direct methods provide rapid reconstruction (ms) and feedback 

→ initial guess for iterative methods, live feedback
:::

## Weak Phase Object (WPO) Method

$$
\Psi(\mathbf{Q}_p) = \sum_{\mathbf{K}_f} \left\{ G(\mathbf{K}_f, \mathbf{Q}_p) \frac{\Gamma_A^*(\mathbf{K}_f, \mathbf{Q}_p)}{|\Gamma_A(\mathbf{K}_f, \mathbf{Q}_p)|} \right\}, \quad \text{for } \mathbf{K}_f \in |\{\Gamma_A(\mathbf{K}_f, \mathbf{Q}_p)| \neq 0\}
$$

![WPO ptychography setup and reconstruction workflow.<br> (d) Fourier transform gives complex 4D data in frequency domain. <br>(e) Frequency-dependent virtual detectors synthesized from phase plate. <br>(f) Phase correction of interference patterns. <br>(g) Object function calculated by integration over detector plane. <br>(h) Inverse Fourier transform yields reconstructed object function. [1]](./wpo/page_003_img_001.png){height="400px"}

::: {.aside}
[1] @Yang_2016
::: 

::: {.callout-note}
WPO contrast is strongly defocus dependent
:::

## Single-Side Band (SSB) Method

$$
\Psi(\mathbf{Q}_p) = \sum_{\mathbf{K}_f} \left\{ G(\mathbf{K}_f, \mathbf{Q}_p) \frac{\Gamma_A^*(\mathbf{K}_f, \mathbf{Q}_p)}{|\Gamma_A(\mathbf{K}_f, \mathbf{Q}_p)|} \right\}, \quad \text{for } \mathbf{K}_f \in \mathrm{double-overlap\,region}
$$

![Phase (top) and amplitude (bottom) of $G(\mathbf{K}_f, \mathbf{Q}_p)$ as a function of $\mathbf{K}_f$ for three $\mathbf{Q}_p$ values with significant amplitude extracted from a four dimensional dataset from a sample of
graphene.[1]](./ssb/page_004_img_001.png){height="500px"}


::: {.aside}
[1] @Pennycook_2015
::: 

::: {.callout-note}
SSB contrast is independent of defocus
:::


## Bayesian Framework for Inverse Problems
::: {.columns}
::: {.column width="55%"}

- **Goal:** Estimate unknown image $\mathbf{x}$ from a diffraction pattern amplitude $\mathbf{y}$
- $p(\mathbf{x} | \mathbf{y})$: posterior probability of the unknown image given the diffraction pattern
- The most likely image, given the measurements:

$$\boxed{\hat{\mathbf{x}} = \arg\min_{\mathbf{x}} -\log p(\mathbf{y}|\mathbf{x}) - \log p(\mathbf{x})}$$

:::
::: {.column width="45%"}
\begin{align*}
\hat{\mathbf{x}} &= \arg\max_{\mathbf{x}} p(\mathbf{x}|\mathbf{y}) \\
&\overset{(i)}{=} \arg\max_{\mathbf{x}} \frac{p(\mathbf{y}|\mathbf{x})p(\mathbf{x})}{p(\mathbf{y})} \\
&\overset{(ii)}{=} \arg\max_{\mathbf{x}} p(\mathbf{y}|\mathbf{x})p(\mathbf{x}) \\
&\overset{(iii)}{=} \arg\max_{\mathbf{x}} \log\left(p(\mathbf{y}|\mathbf{x})p(\mathbf{x})\right) \\
&= \arg\min_{\mathbf{x}} -\log p(\mathbf{y}|\mathbf{x}) - \log p(\mathbf{x}).
\end{align*}
<div style="font-size:0.65em; text-align: right;">
- (i) <b>Bayes' rule:</b> $p(\mathbf{x} | \mathbf{y}) = \dfrac{p(\mathbf{y} | \mathbf{x})\, p(\mathbf{x})}{p(\mathbf{y})}$<br>
- (ii) $p(\mathbf{y})$ does not depend on $\mathbf{x}$<br>
- (iii) The log-likelihood increases monotonically
</div>

:::
:::
 


::: {.callout-note} 
Many modern ptychography algorithms use a Bayesian framework
::: 

## Bayesian Framework for Ptychography

The likelihood for a linear forward model with Gaussian noise is:

$$
p(\mathbf{y}|\mathbf{x}) \sim \exp\left(-\frac{1}{2\sigma^2} \|\mathbf{P}(\mathbf{x}) - \mathbf{y}\|_2^2\right)
$$

where $\mathbf{P}$ is the ptychography measurement operator, $\mathbf{x}$ is the unknown image, $\mathbf{y}$ is the measured data, and $\sigma^2$ is the noise variance.
The negative log-likelihood for a forward model with Gaussian noise is:

$$
-\log p(\mathbf{y}|\mathbf{x}) = \frac{1}{2\sigma^2} \|\mathbf{P}(\mathbf{x}) - \mathbf{y}\|_2^2 + c
$$
The prior term $-\log p(\mathbf{x})$ is often called the *regularization* in optimization. It can be written as:
$$
\lambda \sigma^2 \mathcal{R}(\mathbf{x}) = -\log p(\mathbf{x})
$$
where $\mathcal{R}(\mathbf{x})$ is a regularization function (e.g., enforcing smoothness or sparsity), $\lambda$ is a regularization parameter, and $\sigma^2$ is the noise variance.
The resulting optimization problem for MAP estimation in the case of a linear forward model and Gaussian noise is:

---

$$
\hat{\mathbf{x}} = \arg\min_{\mathbf{x}} \frac{1}{2} \|\mathbf{P}(\mathbf{x}) - \mathbf{y}\|_2^2 + \lambda \mathcal{R}(\mathbf{x})
$$

where 

- $\mathbf{P}(\mathbf{x})$ is the measurement operator, 
- $\mathbf{y}$ is the measured data, 
- $\mathcal{R}(\mathbf{x})$ is the regularization (prior) term, and 
- $\lambda$ controls the strength of the regularization.
<br><br>

- first term enforces data fidelity 
- second term encodes prior knowledge or constraints on the solution (regularization)

---
## Iterative Reconstruction Methods: Basic Ptychography Algorithm
```{python}
#| code-fold: true
import torch
import torch.fft as fft
from torch import Tensor
import skimage.data as skdata  
import skimage.transform as sktrans
import matplotlib.pyplot as plt
from scipy.ndimage import gaussian_filter
import numpy as np
img = skdata.astronaut()

img = sktrans.resize(img, (64, 64))
img = gaussian_filter(img, sigma=1)
# Convert to grayscale by taking mean across color channels
img = np.mean(img, axis=2)
img = img.astype(np.float32) / 255.0
img = torch.from_numpy(img)  
complex_image = torch.polar(torch.ones_like(img), img/img.max()*0.4)
```



::: {.columns}
::: {.column width="55%"}
### Ingredient 1: scanning over the sample 
```{python}
def C(image : Tensor, positions : Tensor, window_size : int) -> Tensor:
    # Cropping operator: crop windows from the image at the given positions
    scan_windows = [] 
    for i, (x, y) in enumerate(positions):
        x_indices = torch.arange(x, x + window_size) % image.shape[1]
        y_indices = torch.arange(y, y + window_size) % image.shape[0] 
        Y, X = torch.meshgrid(y_indices, x_indices, indexing='ij') 
        window = image[Y, X]
        scan_windows.append(window)        
    scan_windows = torch.stack(scan_windows, dim=0)
    return scan_windows
```
:::
::: {.column width="45%"}
### Ingredient 2: propagation / interference
```{python}
def F(wave):
  return fft.fft2(wave)
```
### Simplest Ptychography Model
$$P(\mathbf{x}, \mathbf{\psi}, \mathbf{\rho}) = \left| \mathcal{F} \left( \mathbf{\psi(r)} \cdot \mathbf{C}(\mathbf{x}, \mathbf{\rho}) \right) \right|$$
```{python}
def P(sample, probe, scan_positions):
  # crop the scanning windows, transmit the beam, propagate 
  # to detector, then detect
  return th.abs(F(probe * C(sample, scan_positions, probe.shape[0])))
```
:::
:::
```{python}
#| code-fold: true
import numpy as np
import plotly.graph_objects as go
import plotly.io as pio

# Configure plotly for both VS Code and Quarto rendering
pio.renderers.default = "plotly_mimetype+notebook_connected"

# Define scan grid
size = 8
step = 1
x = torch.arange(0, size, step)
y = torch.arange(0, size, step)
X, Y = torch.meshgrid(x, y, indexing='ij')
positions = torch.stack([X.flatten(), Y.flatten()], dim=1)  # Kx2 array
K = positions.shape[0]

# Example sample image (replace with your own)
sample = complex_image

# Example probe (window size)
probe_size = 32 
probe = torch.ones((probe_size, probe_size))

# Crop image stack
image_stack = C(sample, positions, probe_size)  # shape: (K, probe_size, probe_size)

# Create interactive plotly figure with title "scanning windows"
fig = go.Figure()
# Add initial image
fig.add_trace(go.Heatmap(
    z=np.angle(image_stack[0].detach().cpu().numpy()),
    colorscale='inferno',
    showscale=False
))
# Add slider, set black background, add figure title, and set text color to white
fig.update_layout(
    title=dict(text="Scanning Windows", font=dict(color='white')),
    width=400,
    height=500,
    margin=dict(l=0, r=0, t=40, b=0),
    xaxis=dict(showticklabels=False, showgrid=False, color='white', title_font=dict(color='white')),
    yaxis=dict(showticklabels=False, showgrid=False, color='white', title_font=dict(color='white')),
    sliders=[dict(
        active=0,
        currentvalue={"prefix": "Position: ", "font": {"color": "white"}},
        len=0.9,
        x=0.1,
        xanchor="left",
        y=0,
        yanchor="top",
        steps=[dict(
            method="restyle",
            args=[{"z": [np.angle(image_stack[i].detach().cpu().numpy())]}, [0]],
            label=str(i)
        ) for i in range(K)],
        font=dict(color='white')
    )],
    paper_bgcolor='black',
    plot_bgcolor='black',
    font=dict(color='white')
)
fig.show()

```

## Experimental Design Considerations: parameter flexibility
::: {.columns}
::: {.column width="35%"}

![Adjustable parameters for ptychographic data acquisition [1]](images/ptychoscopy_01.webp){height="550px"}

:::
::: {.column width="65%"}

<div style="font-size:0.75em">

| Limitation/check         | Description                                                        | Default         |
|-------------------------|--------------------------------------------------------------------|-----------------|
| Areal oversampling       | How many probes illuminate each pixel? <br> $$A = \frac{\pi r_p^2}{s^2}$$   | 1.6 - 1e3   |
| Probe sampling           | To which extent is the probe contained in its window? <br> $$P = \frac{1}{2r_pd}$$ | < 0.5         |
| Ronchigram magnification     | Size of the shadow image on the detector plane in units $\frac{pixel}{Å}$ <br> $$M = \frac{\alpha}{\theta \cdot r_p} = \frac{\alpha}{\lambda d \cdot r_p}$$ | 10 - 100 |
</div>

:::
:::

where:

::: {.columns}
::: {.column width="50%"}
- $\alpha$ is the semi-convergence angle
- $\theta$ is the angular sampling in radians
- $s$ is the scan step size
:::
::: {.column width="50%"}
- $r_p$ is the probe radius
- $d$ is the diffraction space sampling
:::
:::
 
::: {.aside}
[1] @Skoupy_2025 [2] @Gilgenbach_2024
:::

## Experimental Design Considerations: sampling


<div class="iframe-container" style="height: 900px;">
<iframe
  id="marimo-frame"
  src="https://pelzlab.science/marimo/apps/ptychographic_sampling.html?mode=read&embed=true"
  frameBorder="0"  
  width="100%"
  height="900px"
  style="border: none; filter: invert(1) hue-rotate(180deg);"
></iframe></div>

::: {.callout-note} 

sampling in diffraction space & defocus → Ronchigram Magnification

sampling in real space & defocus  → Areal oversampling

::: 

## Modeling partial coherence

<div style="font-size: 90%;">
- partial coherence arises from multiple sources in electron microscopy:
  - finite source size --> partial spatial coherence of the electron source [1]
  - finite detector pixel size --> partial spatial coherence
  - finite energy spread inside the column --> partial temporal coherence [1]

- most efficient models:
  - [detector pixel size & source size: convolution in the detector plane [2]]{style="color: green;"}
  - [energy spread & remaining partial coherence: multiple coherent modes [3]]{style="color: red;"}


$$
I(\vec{\rho}, \vec{q}) =\left(\color{red}{\sum_n a_n} \left|\mathcal{F}\left[O(\vec{\vec{r}})\color{red}{\psi_n(\vec{r}-\vec{\rho})}\right]\right|^2\right) \color{green}{\otimes M(\vec{q})}
$$

where:

::: {.columns}
::: {.column width="50%"}
- $\vec{\rho}$ is the position on the detector plane
- $\vec{q}$ is the position in reciprocal space
- $a_n$ is the amplitude of the $n$-th coherent mode
:::
::: {.column width="50%"}
- $O(\vec{r})$ is the aperture function
- $\psi_n(\vec{r}-\vec{\rho})$ is the wave function of the $n$-th coherent mode, shifted by the position $\vec{\rho}$
- $M(\vec{q})$ is the a function modeling modulation transfer function and partial source coherence
:::
:::
</div>

  
::: {.aside}
[1] @Li_2022, [2] @Diederichs_2024, [3] @Thibault_Menzel_2013
:::

## Experimental Design Considerations: coherence

<div class="iframe-container" style="height: 750px;">
<iframe
  id="marimo-frame"
  src="https://pelzlab.science/marimo/apps/ptychographic_coherence.html?mode=read&embed=true"
  frameBorder="0"  
  width="100%"
  height="750px"
  style="border: none; filter: invert(1) hue-rotate(180deg);"
></iframe></div>

::: {.callout-note} 
temporal coherence is no problem at 200-300kV, ~2-3 modes

at low energies 30-60keV, temporal coherence needs more modes

superresolution capabilities circumvent the coherence problem
::: 

## Adding more "nuisance parameters": Refining the scan positions 

- realistic model for thin samples:

$$
P(\mathbf{x}, \mathbf{\psi}, \mathbf{\rho}) = \left|\left(\sum_n a_n \left|\mathcal{F}\left[O(\vec{\vec{r}})\psi_n(\vec{r}-\vec{\rho})\right]\right|^2\right) \otimes M(\vec{q})\right|
$$
 
$$
\hat{\mathbf{x}} = \arg\min_{\color{red}{\mathbf{x}, \mathbf{\psi}, \mathbf{\rho}}} 
\frac{1}{2} \|P(\mathbf{x}, \mathbf{\psi}, \mathbf{\rho}) - \mathbf{y}\|_2^2 + \lambda \mathcal{R}(\mathbf{x}) + \lambda_1 \mathcal{R}_1(\mathbf{\psi}) 
$$

- Todo: picture of the model

::: {.callout-note} 

modern ML frameworks allow us to refine additional parameters easily using automatic gradient calculations

::: 


## Modeling thick samples: the multi-slice algorithm

- Up to now: thin samples, i.e. thickness < depth of field and weak scattering 

::: {.columns}
::: {.column width="50%"}
- Thick samples require modeling of multiple scattering events
- Sample is divided into thin slices that can be treated independently
- Beam propagates through slices sequentially

![Multi-slice propagation model (Adapted from [1])](romanov2024/page_004_img_002.png)
:::

::: {.column width="50%"}
$$\psi_{n+1}(r) = \mathcal{P}_{\Delta z} \left[ t_n(r) \psi_n(r) \right]$$

where:

- $\psi_n(r)$ is the wave at slice n
- $t_n(r)$ is the transmission function
- $\mathcal{P}_{\Delta z}$ is the propagator (usually Fresnel)
- $\Delta z$ is the slice thickness

Key parameters:

- Slice thickness (typically 1-2 nm)
- Number of slices
- Propagation distance
:::
:::

 
::: {.aside}
[1] @Romanov_2024, [2] First demonstration: @Chen_2021
:::

## Multi-slice ptychography (MSP)
| Component | Mathematical Description |
|-----------|-------------------------|
| Multislice algorithm | $$\mathcal{M}_{\psi}(\mathbf{V}) = \prod_{k=0}^T (\mathcal{P}^{\Delta z} T^{\mathbf{V}_k})\psi $$ |
| Multi-slice ptychography model | $$P(\mathbf{V}, \mathbf{\psi}, \mathbf{\rho}) = \left|\left(\color{red}{\sum_n a_n} \left|\mathcal{F}\left[\mathcal{M}_{\color{red}{\psi_n(\vec{r}-\vec{\rho})}}(\mathbf{V})\right]\right|^2\right) \color{green}{\otimes M(\vec{q})}\right|$$ |
| Optimization problem | $$\hat{\mathbf{V}} = \arg\min_{\mathbf{V}, \mathbf{\psi}, \mathbf{\rho}} \frac{1}{2} \|P(\mathbf{V}, \mathbf{\psi}, \mathbf{\rho}) - \mathbf{y}\|_2^2 + \lambda \mathcal{R}(\mathbf{V}) + \lambda_1 \mathcal{R}_1(\mathbf{\psi}) $$ |

<!-- $$
P(\mathbf{V}, \mathbf{\psi}, \mathbf{\rho}) = \left|\left(\color{red}{\sum_n a_n} \left|\mathcal{F}\left[\mathcal{M}_{\color{red}{\psi_n(\vec{r}-\vec{\rho})}}(\mathbf{V})\right]\right|^2\right) \color{green}{\otimes M(\vec{q})}\right|
$$
 
$$
\hat{\mathbf{V}} = \arg\min_{\mathbf{V}, \mathbf{\psi}, \mathbf{\rho}} 
\frac{1}{2} \|P(\mathbf{V}, \mathbf{\psi}, \mathbf{\rho}) - \mathbf{y}\|_2^2 + \lambda \mathcal{R}(\mathbf{V}) + \lambda_1 \mathcal{R}_1(\mathbf{\psi}) 
$$ -->

::: {.callout-note} 

We have arrived at the state of the art in ptychography:

3D imaging with deep-sub-angstrom lateral and ~2nm depth resolution
::: 

## Constraints in MSP: positive potential, amplitude~1, blur kernel

::: {.columns}
::: {.column width="33%"}
**Constraint 1: Positive Potential**

- The electrostatic potential $V(\mathbf{r})$ must be physically meaningful: $V(\mathbf{r}) \geq 0$
- Enforced during optimization by projecting negative values to zero
- Prevents unphysical solutions and improves stability

:::
::: {.column width="33%"}
**Constraint 2: Amplitude $\approx 1$**

- The transmission function $t_n(\mathbf{r})$ should have amplitude close to 1 (very few electrons scattered outside the 4D-STEM detector are registered as "amplitude contrast")
- Enforced by regularization: penalize deviations from $|t_n(\mathbf{r})| = 1$


:::
::: {.column width="33%"}
**Constraint 3: Blur Kernel**

- in (x,y) plane: stabilize deep-sub-angstrom resolution reconstructions
- in z-direction: limit depth resolution, disallow higher than 1nm depth resolution
- early algorithms: Fourier-space convolution --> leads to wrap-around artefacts for non-periodic samples

:::
:::

## Extensions of MSP: mistilt correction

::: {.columns}
::: {.column width="50%"}
![Slight misorientation of the zone axis can lead to stricter requirements for the slice thickness.<br>Solution: include the mistilt in the propagator, refine it during the reconstruction<br>Adapted from [1]](sha/page_004_img_002.png)
:::
::: {.column width="50%"}
![Adaptive propagator requires less slices<br>--> Faster reconstructions<br>Adapted from [1]](sha/page_004_img_003.png){height="700px"}
:::
:::

::: {.callout-note} 

Slight deviations from the perfect zone axis can be refined algorithmically

::: 




::: {.aside}
[1] @Sha_Cui_Yu_2022
:::

## Extensions of MSP: atomistic models

 
::: {.columns}
::: {.column width="50%"}

Assemble the electrostatic potential from atomic positions and atomic numbers

$$O_l(\mathbf{r}) = A_l(\mathbf{r}) e^{i \sigma_e V_{\mathrm{FP}}^{(j)}(\mathbf{r}, \boldsymbol{\tau})}$$

$$
V_{\mathrm{FP}}^{(j)}(\mathbf{r}, \boldsymbol{\tau}) = \sum_{n=1}^{N} w_n v_{Z_n} \left( \mathbf{r} - \mathbf{r}_n - \sqrt{\langle u_n^2 \rangle} \cdot \mathbf{g}_{n, \tau} \right)
$$

:::
::: {.column width="50%"}
![Atomistic model for the reconstructed potential (Adapted from [2])](atomistic/page_002_img_002.png){height="500px"}
::: 
:::


::: {.callout-note} 

Atomic positions can be refined directly 

--> interpretable model, enables phonon modeling

--> sparse model --> achieves higher resolution than voxelized models

--> phonon modeling --> might enable imaging of phonon modes
::: 




::: {.aside}
[1] @Yang_2024 [2] @Diederichs_2024
:::

## Applications of MSP: 3D imaging 



## Applications of MSP: ultra low-dose imaging



## Limitations of MSP: axial resolution

::: {.callout-note} 
Axial resolution of MSP is limited to below atomic scale if not using the most cutting edge instrumentation


::: 

## Full 3D: ptychographic tomography
::: {.columns}
::: {.column width="50%"}
![Perform MSP reconstruction <br>for each tilt angle<br>and project the potential along z
<br><br><br><br><br><br><br><br> ✅ Advantages:<br>
- Decouple tomographic alignment from ptychographic reconstruction<br>
- Can use positions and alignment as input to E2E-MSPT
](./extracted_media/image74.png){width="80%"}
:::

::: {.column width="50%"}
![Multi-slice Ptychographic Tomography forward model<br>
<br>❌ Disadvantage:<br>
- Loses some 3D info from MSP
](./extracted_media/image75.png){width="80%"}
:::
:::

<img src="./extracted_media/image73.png" style="position: absolute; top: 0; right: -150px; width: 150px; z-index: 10;">
<img src="./extracted_media/image69.png" style="position: absolute; top: 200px; right: -150px; width: 150px; z-index: 10;">

::: aside
@Romanov_2024
:::

## Full 3D: ptychographic tomography

## Joint Tomography and Rigid Alignment enables atomic resolution of beyond-DOF volumes

![](./extracted_media/image75.png){width="35%"}
 
::: {.callout-note}
Enabled by reaching sub-pixel alignment at each scale
:::


::: aside
@Romanov_2024
:::

## 3x DOF volumes display atomic resolution

::: {.columns}
::: {.column width="50%"}
![](./extracted_media/image77.gif)
:::

::: {.column width="50%"}
![](./extracted_media/media21.mp4){controls="true" autoplay="true" loop="true" width="100%"}
:::
:::

::: {.callout-note}
Volume size: (18.2 nm)<sup>3</sup>
Voxel size: 0.3 Å
:::

::: aside
@Romanov_2024
:::

## Orthoslices reveal lattice in all 3 dimensions

![scale: 1 nm](./extracted_media/image80.png)

::: {.callout-note}
Lattice resolved, but Co atom contrast overpower O contrast<br>
=> Around 1 Å z resolution required to resolve O atoms
:::

::: aside
@Romanov_2024
:::

## End-to-end reconstruction - putting all pieces together

::: {.columns}
::: {.column width="50%"}
Fully E2E-MSPT reconstruction includes

1. affine resampling of potential volume<br>
2. z-resampling of potential volume (save compute)<br>
3. batch-croppping and mixed-state multi-slice model<br>
4. far-field propagation<br>
5. gradient backpropagation through full model 
:::

::: {.column width="50%"}
![](./extracted_media/image88.png){width="70%"}
:::
:::

::: {.callout-note}
The most accurate approximation for 4D-STEM tomography to-date 
::: 

::: aside
@You_Romanov_Pelz_2024
:::

<img src="./extracted_media/image169.png" style="position: absolute; top: 0px; right: -150px; width: 150px; z-index: 10;">

## Ptychographic tomography: Applications

## Outlook 1: From Imaging Structure to Imaging Fields


::: {.callout-note}
We will see continued improvements in quantitative imaging of fields accessible by electron microscopy
::: 

## Outlook 2: From Imaging Static Structure to Imaging Dynamics



::: {.callout-note}
We will see in-situ applications of ptychography as the codes become faster and more standardized
::: 

## Outlook 3: From Imaging Ordered Structures to Imaging Disorder


::: {.callout-note}
We will see images and volumes of more and more disordered structures
::: 




## Outlook: Fields, Disorder, Dynamics




## Summary
::: {.columns}
::: {.column width="66%"}
- Ptychography has a multitude of experimental settings to control and algorithms to explore
- When tuned well, result well beyond hardware capabilities can be expected 
- Modern ML tools alleviate algorithm development and application by non-experts 

### Open positions at FAU

- 13 open Ph.D. positions in the new Graduate School "Correlative Microscopy"
- Develop Sensor Fusion of 4D-STEM + APT, 4D-STEM + EELS, 4D-STEM + Raman Microscopy

:::

::: {.column width="33%"}
![](./extracted_media/media1.mp4){width="50%" loop="true" autoplay="true" style="margin-left: auto; margin-right: 0; display: block;"}
![](./extracted_media/media21.mp4){width="50%" loop="true" autoplay="true" style="margin-left: auto; margin-right: 0; display: block;"}
![](./extracted_media/media23.mp4){width="50%" loop="true" autoplay="true" style="margin-left: auto; margin-right: 0; display: block;"}
:::
 
:::

## References 📚 

::: {#refs}
:::









<div>
<script>



document.getElementById("marimo-frame").onload = function() {
    try {
        let iframeDoc = document.getElementById("marimo-frame").contentWindow.document;
        let marimoBadge = iframeDoc.querySelector("div.fixed.bottom-0.right-0.z-50");
        if (marimoBadge) {
            marimoBadge.style.display = "none";
            console.log("Marimo badge hidden successfully.");
        } else {
            console.log("Badge not found.");
        }
    } catch (error) {
        console.warn("Unable to modify iframe content due to CORS restrictions.");
    }
};
</script>
</div>